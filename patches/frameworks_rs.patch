From 66d5699bb34f703f7287736ff60aeea7eb9309a5 Mon Sep 17 00:00:00 2001
From: Joe Maples <frap129@gmail.com>
Date: Fri, 25 Dec 2015 18:19:59 -0500
Subject: [PATCH 1/4] runtime: Fix compile with newer Clang versions

Credits to mustermaxmuller

Signed-off-by: Joe Maples <frap129@gmail.com>
---
 driver/runtime/arch/generic.c  | 15 +++++++--------
 driver/runtime/rs_allocation.c |  9 +++------
 driver/runtime/rs_sample.c     |  4 +++-
 3 files changed, 13 insertions(+), 15 deletions(-)

diff --git a/driver/runtime/arch/generic.c b/driver/runtime/arch/generic.c
index 9bd1bd6..a06723e 100644
--- a/driver/runtime/arch/generic.c
+++ b/driver/runtime/arch/generic.c
@@ -634,14 +634,13 @@ extern uchar4 __attribute__((overloadable)) rsYuvToRGBA_uchar4(uchar y, uchar u,
     short V = ((short)v) - 128;
 
     short4 p;
-    p.r = (Y * 298 + V * 409 + 128) >> 8;
-    p.g = (Y * 298 - U * 100 - V * 208 + 128) >> 8;
-    p.b = (Y * 298 + U * 516 + 128) >> 8;
-    p.a = 255;
-    p.r = rsClamp(p.r, (short)0, (short)255);
-    p.g = rsClamp(p.g, (short)0, (short)255);
-    p.b = rsClamp(p.b, (short)0, (short)255);
-
+    p.x = (Y * 298 + V * 409 + 128) >> 8;
+    p.y = (Y * 298 - U * 100 - V * 208 + 128) >> 8;
+    p.z = (Y * 298 + U * 516 + 128) >> 8;
+    p.w = 255;
+    p.x = rsClamp(p.x, (short)0, (short)255);
+    p.y = rsClamp(p.y, (short)0, (short)255);
+    p.z = rsClamp(p.z, (short)0, (short)255);
     return convert_uchar4(p);
 }
 
diff --git a/driver/runtime/rs_allocation.c b/driver/runtime/rs_allocation.c
index 8c8d1ba..d287b2d 100644
--- a/driver/runtime/rs_allocation.c
+++ b/driver/runtime/rs_allocation.c
@@ -286,15 +286,12 @@ ELEMENT_AT(double3)
 ELEMENT_AT(double4)
 
 typedef unsigned long long ull;
-typedef unsigned long long ull2 __attribute__((ext_vector_type(2)));
-typedef unsigned long long ull3 __attribute__((ext_vector_type(3)));
-typedef unsigned long long ull4 __attribute__((ext_vector_type(4)));
+typedef unsigned long ull2 __attribute__((ext_vector_type(2)));
+typedef unsigned long ull3 __attribute__((ext_vector_type(3)));
+typedef unsigned long ull4 __attribute__((ext_vector_type(4)));
 
 #ifndef RS_DEBUG_RUNTIME
 SET_ELEMENT_AT_TYPE(ull, ulong)
-SET_ELEMENT_AT_TYPE(ull2, ulong2)
-SET_ELEMENT_AT_TYPE(ull3, ulong3)
-SET_ELEMENT_AT_TYPE(ull4, ulong4)
 
 #undef SET_ELEMENT_AT_TYPE
 #undef GET_ELEMENT_AT_TYPE
diff --git a/driver/runtime/rs_sample.c b/driver/runtime/rs_sample.c
index 95620e3..b655729 100644
--- a/driver/runtime/rs_sample.c
+++ b/driver/runtime/rs_sample.c
@@ -259,7 +259,9 @@ static float4 __attribute__((overloadable))
     float3 r = p0 * w0 + p1 * w1 + p2 * w2 + p3 * w3;
     r *= (1.f / 255.f);
     float4 ret;
-    ret.rgb = r;
+    ret.x = r.x;
+    ret.y = r.y;
+    ret.z = r.z;
     ret.w = 1.f;
     return ret;
 }
-- 
2.7.4


From 8fc6b9693244c837c2d8d272daffc257aa842d15 Mon Sep 17 00:00:00 2001
From: Joe Maples <frap129@gmail.com>
Date: Fri, 25 Dec 2015 21:44:11 -0500
Subject: [PATCH 2/4] runtime: Turns out DragonTC wont work

Signed-off-by: Joe Maples <frap129@gmail.com>
---
 driver/runtime/build_bc_lib_internal.mk | 20 +++++++++++++-------
 1 file changed, 13 insertions(+), 7 deletions(-)

diff --git a/driver/runtime/build_bc_lib_internal.mk b/driver/runtime/build_bc_lib_internal.mk
index 950f60f..f120885 100644
--- a/driver/runtime/build_bc_lib_internal.mk
+++ b/driver/runtime/build_bc_lib_internal.mk
@@ -18,15 +18,21 @@ ifndef BCC_RS_TRIPLE
 BCC_RS_TRIPLE := $($(LOCAL_2ND_ARCH_VAR_PREFIX)RS_TRIPLE)
 endif
 
+AOSP_LLVM_PREBUILTS_VERSION := 3.6
+AOSP_LLVM_PREBUILTS_PATH := prebuilts/clang/$(BUILD_OS)-x86/host/$(LLVM_PREBUILTS_VERSION)/bin
+AOSP_CLANG := $(AOSP_LLVM_PREBUILTS_PATH)/clang$(BUILD_EXECUTABLE_SUFFIX)
+AOSP_LLVM_LINK := $(AOSP_LLVM_PREBUILTS_PATH)/llvm-link$(BUILD_EXECUTABLE_SUFFIX)
+AOSP_LLVM_AS := $(AOSP_LLVM_PREBUILTS_PATH)/llvm-as$(BUILD_EXECUTABLE_SUFFIX)
+
 # Set these values always by default
 LOCAL_MODULE_TAGS := optional
 LOCAL_MODULE_CLASS := SHARED_LIBRARIES
 
 include $(BUILD_SYSTEM)/base_rules.mk
-
+include $(BUILD_SYSTEM)/dragontc.mk
 BCC_STRIP_ATTR := $(BUILD_OUT_EXECUTABLES)/bcc_strip_attr$(BUILD_EXECUTABLE_SUFFIX)
 
-bc_clang := $(CLANG)
+bc_clang := $(AOSP_CLANG)
 ifdef RS_DRIVER_CLANG_EXE
 bc_clang := $(RS_DRIVER_CLANG_EXE)
 endif
@@ -81,9 +87,9 @@ $(c_bc_files): $(intermediates)/%.bc: $(LOCAL_PATH)/%.c $(bc_clang)
 	$(hide) $(bc_clang) $(addprefix -I, $(PRIVATE_INCLUDES)) $(PRIVATE_CFLAGS) $< -o $@
 	$(call transform-d-to-p-args,$(@:%.bc=%.d),$(@:%.bc=%.P))
 
-$(ll_bc_files): $(intermediates)/%.bc: $(LOCAL_PATH)/%.ll $(LLVM_AS)
+$(ll_bc_files): $(intermediates)/%.bc: $(LOCAL_PATH)/%.ll $(AOSP_LLVM_AS)
 	@mkdir -p $(dir $@)
-	$(hide) $(LLVM_AS) $< -o $@
+	$(hide) $(AOSP_LLVM_AS) $< -o $@
 	$(call transform-d-to-p-args,$(@:%.bc=%.d),$(@:%.bc=%.P))
 
 -include $(c_bc_files:%.bc=%.P)
@@ -91,11 +97,11 @@ $(ll_bc_files): $(intermediates)/%.bc: $(LOCAL_PATH)/%.ll $(LLVM_AS)
 
 $(LOCAL_BUILT_MODULE): PRIVATE_BC_FILES := $(c_bc_files) $(ll_bc_files)
 $(LOCAL_BUILT_MODULE): $(c_bc_files) $(ll_bc_files)
-$(LOCAL_BUILT_MODULE): $(LLVM_LINK) $(clcore_LLVM_LD)
-$(LOCAL_BUILT_MODULE): $(LLVM_AS) $(BCC_STRIP_ATTR)
+$(LOCAL_BUILT_MODULE): $(AOSP_LLVM_LINK) $(clcore_LLVM_LD)
+$(LOCAL_BUILT_MODULE): $(AOSP_LLVM_AS) $(BCC_STRIP_ATTR)
 	@echo "bc lib: $(PRIVATE_MODULE) ($@)"
 	@mkdir -p $(dir $@)
-	$(hide) $(LLVM_LINK) $(PRIVATE_BC_FILES) -o $@.unstripped
+	$(hide) $(AOSP_LLVM_LINK) $(PRIVATE_BC_FILES) -o $@.unstripped
 	$(hide) $(BCC_STRIP_ATTR) -o $@ $@.unstripped
 
 BCC_RS_TRIPLE :=
-- 
2.7.4


From 6687c78d73fd81697dd0f1e65722dd88454bc956 Mon Sep 17 00:00:00 2001
From: Joe Maples <frap129@gmail.com>
Date: Sat, 26 Dec 2015 14:41:44 -0500
Subject: [PATCH 3/4] runtime: Simplify

Signed-off-by: Joe Maples <frap129@gmail.com>
---
 driver/runtime/build_bc_lib_internal.mk | 3 +--
 1 file changed, 1 insertion(+), 2 deletions(-)

diff --git a/driver/runtime/build_bc_lib_internal.mk b/driver/runtime/build_bc_lib_internal.mk
index f120885..c76e822 100644
--- a/driver/runtime/build_bc_lib_internal.mk
+++ b/driver/runtime/build_bc_lib_internal.mk
@@ -18,8 +18,7 @@ ifndef BCC_RS_TRIPLE
 BCC_RS_TRIPLE := $($(LOCAL_2ND_ARCH_VAR_PREFIX)RS_TRIPLE)
 endif
 
-AOSP_LLVM_PREBUILTS_VERSION := 3.6
-AOSP_LLVM_PREBUILTS_PATH := prebuilts/clang/$(BUILD_OS)-x86/host/$(LLVM_PREBUILTS_VERSION)/bin
+AOSP_LLVM_PREBUILTS_PATH := prebuilts/clang/$(BUILD_OS)-x86/host/3.6/bin
 AOSP_CLANG := $(AOSP_LLVM_PREBUILTS_PATH)/clang$(BUILD_EXECUTABLE_SUFFIX)
 AOSP_LLVM_LINK := $(AOSP_LLVM_PREBUILTS_PATH)/llvm-link$(BUILD_EXECUTABLE_SUFFIX)
 AOSP_LLVM_AS := $(AOSP_LLVM_PREBUILTS_PATH)/llvm-as$(BUILD_EXECUTABLE_SUFFIX)
-- 
2.7.4


From 03a6ec3427841db6ad7f32344e4ae7945dec391a Mon Sep 17 00:00:00 2001
From: Joe Maples <frap129@gmail.com>
Date: Sat, 2 Jan 2016 18:26:04 -0500
Subject: [PATCH 4/4] runtime: Remove hardcoded locations for AOSP clang

Signed-off-by: Joe Maples <frap129@gmail.com>
---
 driver/runtime/build_bc_lib_internal.mk | 7 +------
 1 file changed, 1 insertion(+), 6 deletions(-)

diff --git a/driver/runtime/build_bc_lib_internal.mk b/driver/runtime/build_bc_lib_internal.mk
index c76e822..6275b88 100644
--- a/driver/runtime/build_bc_lib_internal.mk
+++ b/driver/runtime/build_bc_lib_internal.mk
@@ -18,17 +18,12 @@ ifndef BCC_RS_TRIPLE
 BCC_RS_TRIPLE := $($(LOCAL_2ND_ARCH_VAR_PREFIX)RS_TRIPLE)
 endif
 
-AOSP_LLVM_PREBUILTS_PATH := prebuilts/clang/$(BUILD_OS)-x86/host/3.6/bin
-AOSP_CLANG := $(AOSP_LLVM_PREBUILTS_PATH)/clang$(BUILD_EXECUTABLE_SUFFIX)
-AOSP_LLVM_LINK := $(AOSP_LLVM_PREBUILTS_PATH)/llvm-link$(BUILD_EXECUTABLE_SUFFIX)
-AOSP_LLVM_AS := $(AOSP_LLVM_PREBUILTS_PATH)/llvm-as$(BUILD_EXECUTABLE_SUFFIX)
-
 # Set these values always by default
 LOCAL_MODULE_TAGS := optional
 LOCAL_MODULE_CLASS := SHARED_LIBRARIES
 
+
 include $(BUILD_SYSTEM)/base_rules.mk
-include $(BUILD_SYSTEM)/dragontc.mk
 BCC_STRIP_ATTR := $(BUILD_OUT_EXECUTABLES)/bcc_strip_attr$(BUILD_EXECUTABLE_SUFFIX)
 
 bc_clang := $(AOSP_CLANG)
-- 
2.7.4

